#!/usr/bin/env python
#
# This file is part of ddr-cmdln/kura
#

import argparse
import sys

from Kura.collection import OPERATIONS, description, epilog
from Kura.collection import create, destroy, update, sync
from Kura.collection import entity_create, entity_destroy, entity_update, entity_annex_add

def main():
    parser = argparse.ArgumentParser(description=description, epilog=epilog)
    # no positional arguments
    parser.add_argument('operation', choices=OPERATIONS,
                        help='Operation to perform.')
    parser.add_argument('-c', '--collection',
                        help='Absolute file path to the collection')
    parser.add_argument('-e', '--entity',
                        help='UID of entity to be added/removed to/from collection.')
    parser.add_argument('-f', '--file',
                        help='Relative path to updated file.')
    parser.add_argument('-u', '--user',
                        help='User who is performing the change.')
    parser.add_argument('-m', '--mail',
                        help='Email of user.')
    parser.add_argument('-d', '--debug', action='store_true',
                        help='Debug; prints lots of debug info.')
    args = parser.parse_args()

    if args.debug:
        print(args)

    messages = []
    if not args.user:
        messages.append('specify a user')
    if not args.mail:
        messages.append('specify an email address')
    if not args.operation:
        messages.append('choose an operation')
    if (args.operation in ['add', 'update']) and not (args.file):
        messages.append('specify an file')
    if (args.operation in ['ecreate','edestroy','eupdate', 'eadd']) and not (args.entity):
        messages.append('specify an entity')
    if (args.operation in ['eupdate','eadd']) and not (args.file):
        messages.append('specify a file')
    if messages:
        for m in messages:
            sys.stderr.write('ERR: {}\n'.format(m))
        sys.exit(1)
    
    # do something
    if   args.operation == 'status':   status(args.collection, args.debug)
    elif args.operation == 'create':   create(        args.user, args.mail, args.collection,              args.debug)
    elif args.operation == 'destroy':  destroy(       args.user, args.mail, args.collection,              args.debug)
    elif args.operation == 'update':   update(        args.user, args.mail, args.collection, [args.file],   args.debug)
    elif args.operation == 'sync':     sync(          args.user, args.mail, args.collection,              args.debug)
    elif args.operation == 'ecreate':  entity_create( args.user, args.mail, args.collection, args.entity, args.debug)
    elif args.operation == 'edestroy': entity_destroy(args.user, args.mail, args.collection, args.entity, args.debug)
    elif args.operation == 'eupdate':  entity_update( args.user, args.mail, args.collection, args.entity, [args.file],   args.debug)
    elif args.operation == 'eadd':     entity_annex_add(args.user,args.mail,args.collection, args.entity, args.file,   args.debug)
    else:
        sys.stderr.write('We fell through!\n')
        sys.exit(1)

if __name__ == '__main__':
    main()
